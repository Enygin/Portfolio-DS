# Отчет по проекту
## Задача
  
Оператор связи «ТелеДом» хочет бороться с оттоком клиентов путем предложения промокодов и специальных условий тем клиентам, кто планирует отказаться от услуг оператора связи.

В нашем распоряжении есть собранные командой оператора связи персональные данные о некоторых клиентах, информация об их договорах, тарифах и услугах. В данном исследовании мы изучаем какие есть зависимости в данных и анализируем какие абоненты больше склонны к расторжению договора обслуживания.

Наша цель - построить модель машинного обучения, прогнозирующая отток клиентов.  
Основываясь на этом предсказании оператор связи планирует выстроить систему индивидуального подхода к склонным к оттоку абонентам.  

## Предобработка данных и EDA  
**Данные**  
Для целей настоящего исследования оператором связи «ТелеДом» предоставлены 4 датасета с информацией о договоре, персональными данными клиента, информация об интернет-услугах и услухах телефонии в отношении 7043 его абонентов, заключивших договор в период с 1 октября 2013 года по 1 февраля 2020 года.  
Данные достаточно хорошего качества. Устранено незначительное количество пропущенных данных по общим расходам клиента - все пропуски наблюдались у клиентов, заключивших договор с оператором связи в последний доступный в датасете день. При этом по этим клиентам имелась информация по расходам за первый месяц. Этими данными и были заполнены пропуски.  
Проведена работа по приведению типов данных к нужным.

**Объединение данных**  
Все четыре датасета по завершении предобработки данных были объеденены в один общий датасет. Объединение датасетов прошло корректно - количестов уникальных клиентов не изменилось. Результаты объедиения данных показали, что 1526 абонентов не пользуются интернетом, а 682 телефонной связью. Образовавшиеся в процессе объединения датасетов пропуски у таких абонентов были заполнены значениями *No_internet* и *No_phone* соответственно.

**Анализ популярности услуг**  
В объединенном датасете есть информация о семи услугах, оказываемых оператором связи:
| признак (услуга)    | краткое описание   |
|----------|:----------|
| online_security    | блокировка опасных сайтов   |
| online_backup      | облачное хранилище файлов для резервного копирования данных   |
| device_protection    | антивирус   |
| tech_support    | выделенная линия технической поддержки   |
| streaming_tv    | стриминговое телевидение   |
| streaming_movies    | каталог фильмов   |
| multiple_lines    | подключение телефона к нескольким линиям одновременно   |

Чтобы понять каким сервисам отдают предпочтения разные группы абонентов и есть ли между ними большие отличия, был проведен сравнительный анализ количества используемых сервисов в разрезе статуса абонента (пол, семейный статус, наличие детей и пенсионный возраст).
* Мужчины и женщины пользуются примерно одинаковым набором услуг. Небольшое отличие наблюдается в частоте использования облачного хранилища и антивируса - мужчины чаще используют антивирус, а женщины чаще облачное хранение.
* Пенсионеры заметно реже подключают услугу блокировки опасных сайтов и выделенную линию поддержки.
* Популярность услуг среди женатых абонентов не сильно отличается от среднего распределения услуг мужчин и женщин.
* В группе абонентов с детьми наблюдаются наибольшее отличие от популярности услуг в остальных группах - здесь нет ярковыраженных услуг, пользующихся популярностью. Количество подключенных услуг, за исключением услуги подключения телефона к нескольким линиям одновременно, распределено более равномерно. По сравнению с другими рассмотреными группами, абоненты с детьми заметно чаще пользуются услугами блокировки опасных сайтов, выделенной линии технической поддержки, облачного хранения файлов, антивируса и каталога фильмов.

**Формирование целевого признака**  
Целевой признак `churn` был сформирован из информации о дате окончания действия договора на обслуживание - у клиентов с завершенным договором была указана дата окончания действия договора, а у действующих абонентов - значение *No*.
В рассматриваемых данных отток абонентов оператора связи составляет 16%. 

**Отток клиентов**  
Исследование показало, что оттоку больше подвержены «платящие» клиенты, которые используют большое количество сервисов оператора связи и на которых приходится большие показатели общих расходов. Клиенты, которые используют большинство сервисов, уходят в первые 2-4 года.  
После 4 лет наблюдается «переломный момент» - когда существенно увеличивается лояльность абонентов и практически прекращается их отток. Однако количество таких клиентов не велико.  
Основная часть клиентов - это неплатящие, либо мало платящие абоненты - те, кто является абонентом до 1 года или не имеют подлюченных услуг.

## Конструирование новых признаков и подготовка данных для обучения моделей
Было сконструировано два новых признака:
* **`duration_contract` - общая продолжительность действия договора (в днях).**  
Этот признак сконструирован исходя из разности двух дат - окончания и начала действия договора. При обучении моделей также тестировался этот признак, выраженный в месяцах. Анализ полученных метрик и оценка важности признаков для моделей в конечном итоге повлияли на выбор продолжительности действия договора в днях.  
По результатам наблюдения за работой лучшей модели, отобранной из числа обученных в данной работе, это признак стал самым важным для предсказания оттока клиентов.

* **`count_services` - количество используемых сервисов.**  
В объединенном датасете есть информация о семи сервисах, используемых абонентами, но основе которой и был сконструирован признак.  
В этом признаке наблюдается вполне предсказуемая закономерность - чем больше подключенных услуг, тем меньше таких клиентов.  
  * 24% абонентов не подключены ни к одной услуге 
  * 16% абонентов пользуются одной услугой
  * по 14% абонентов пользуются двумя, тремя и четыремя услугми
  * 10% абонентов подключены к пяти услугам; 6% - к шести и 3% к семи услугам.
  * В количественном выражении число действующих абонентов уменьшается по мере увеличения числа подключенных у них услуг. И наоборот - по мере увеличения числа подключенных услуг у абонента, растет количество уходящих клиентов.
Наибольшая доля оттока в разрезе количества подключенных услуг у абонентов с пятью такими услугами - примерно 50%.

Было удалено три признака. Целевой признак `churn` имел очень высокую корреляцию с датой окончания действия договора, а продолжительность действия договора имела очень высокую корреляцию с датой начала действия договора. Здесь есть риск утечки информации о целевом признаке, поэтому даты начала и окончания действия договора на обслуживание были исключены из обучающей выборки. Также был удален признак уникального идентификатора абонента.  

**Анализ дисбаланса классов**  
Классы несбалансированны. В имеющемся наборе данных доля негативных примеров с ушедшими клиентами слишком мала - всего 16%.  
Дисбаланс классов обусловлен природой самих данных и такая пропорция классов представляется правдоподобной.  
Учитывая это, в данной работе не проводилась работа по борьбе с дисбалансом, а использовались модели машинного обучения на основе деревьев решений, в том числе бустинговые, которые устойчивы к дисбалансу классов:
* *Random Forest* - бейзлайновая модель
* *Cat Boost*
* *LightGBM*
* *XGBoost*

**Обучающая и тестовая выборка**  
Датасет был разделен на обучающую и тестовую выборки методом *train_test_split*, размер тестовой выборки - 25%.  
Размеры обучающей/тестовой выборок: 5282/1761

**Пайплайн трансформации данных**  
Для бейзлайновой модели *Random Forest Classifier* был построен пайплайн подготовки данных с помощью метода *make_column_transformer*.  
Количественные признаки приведены в единый масштаб с помощью *StandardScaler*, а категориальные признаки закодированы методом *OneHotEncoder*.  
Для *Cat Boost* использовался встроенный кодировщик, а для корректной работы моделей *LightGBM* и *XGBoost* с категориальными признаками они были преобразованы к типу данных *category*.

# Обучение моделей машинного обучения
С учетом дисбаланса классов в целевом признаке, в данном исследовании обучены четыре модели классификации на основе деревьев решений (*Random Forest*, *Cat Boost*, *LightGBM* и *XGBoost*).  
Эффективность работы моделей сравнивалась по метрике *ROC-AUC*, на которую также не влияет дисбаланс.

**Модель *Random Forest*** - бейзлайновая модель

Для подбора гиперпараметров использовался *GridSearchCV*.  
Наилучший результат *ROC-AUC* на кросс-валидации: 0.83

**Модель *LightGBM***

Для подбора гиперпараметров использовался RandomizedSearchCV.  
Наилучший результат *ROC-AUC* на кросс-валидации: 0.89.

**Модель *Cat Boost* - лучшая модель**

Для кодирования категориальных признаков использовался встроенный в *CatBoostClassifier* кодировщик.  
Для подбора гиперпараметров также использовался RandomizedSearchCV.  
Наилучший результат *ROC-AUC* на кросс-валидации: 0.91 - лучший из числа обученных моделей.

Этот результат модель показала на следующих подобранных гиперпараметрах:
* число деревьев в случайном лесу (*iterations*) - 300;
* максимальная глубина деревьев (*depth*) - 2;
* скорость обучения (*learning_rate*) - 0,6;
* коэффициент регуляризации L2 (*l2_leaf_reg*) - 6.

## Тестирование лучшей модели

**Метрики качества**  
На тестовых данных модель *Cat Boost* показала следующие результаты:

| roc_auc_score  | accuracy_score | recall         | precision      | F1-мера        |
|:--------------:|:--------------:|:--------------:|:--------------:|:--------------:|
| **0.93**       | **0.92**       | **0.56**       | **0.93**       | **0.7**        |

Из 1761 предсказаний на тестовой выборке:
  * модель верно классифицировала 1619 абонентов (92% от общего количества предсказаний):
    * 1457 (82,7%) абонентов, которые не уходят
    * 162 (9,2%) абонента, которые перестают пользоваться услугами оператора связи.  
  * модель ошиблась 142 раза (8% от всех предсказаний):
    * 13 (0,7%) ложно-положительных предсказаний - то есть 13 абонентов неверно были отнесены к действующим клиентам, хотя на самом деле они уходящие
    * 129 (7,3%) ложно-отрицательных предсказаний - то есть 129 лояльных клиентов были ошибочно классифицированы как уходящие

**Важность признаков**  
Самый важный для работы модели признак - `duration_contract` (общая продолжительность действия договора в днях). Этот признак лидирует с существенным отрывом. был сконструирован из двух имеющихся в датасете дат - начала и окончания действия договора.  
В TOP-5 важных признаков также вошли: 
* `type` (тип оплаты: раз в год-два или ежемесячно)
* `monthly_charges` (расходы за месяц)
* `total_charges` (общие расходы абонента)
* `count_services` (количество используемых сервисов)

Практически нулевые коэффициенты получили следующие признаки:
* `gender` (пол абонента)
* `device_protection` (антивирус)
* `streaming_movies` (каталог фильмов)
* `paperless_billing` (электронный расчётный лист)






## Рекомендации 
